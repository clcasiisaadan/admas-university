<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Admin | ADMAS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="Admin.css">
    <style>
        /* CSS-ka Review Modal-ka */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 800px; border-radius: 12px; overflow-y: auto; max-height: 90vh; position: relative; }
        .review-header { background: #0a2540; color: white; padding: 20px; text-align: center; }
        .close { position: absolute; right: 20px; top: 15px; color: white; cursor: pointer; font-size: 28px; }
        .review-body { padding: 30px; }
        .form-section-title { background: #f4f7fa; padding: 10px; font-weight: bold; border-left: 4px solid #0099ff; margin: 20px 0 15px; color: #0a2540; }
        .form-look-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .view-group label { display: block; font-size: 11px; color: #888; font-weight: bold; text-transform: uppercase; }
        .view-group span { display: block; font-size: 15px; padding: 5px 0; border-bottom: 1px solid #eee; color: #333; }
        .doc-preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .doc-box img { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; background: #fafafa; }
        .badge { background: #ff4d4d; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        .btn-submit { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; width: 100%; }
        
        /* Search Box Style */
        .search-container { position: relative; margin: 15px 0; }
        .search-container i { position: absolute; left: 10px; top: 12px; color: #888; }
        .search-container input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2><i class="fas fa-university"></i> ADMAS</h2>
    <div class="nav-link active" onclick="showTab('newRequests')">
        <i class="fas fa-user-clock"></i> New Requests <span id="reqBadge" class="badge">0</span>
    </div>
    <div class="nav-link" onclick="showTab('register')"><i class="fas fa-user-plus"></i> Register Student</div>
    <div class="nav-link" onclick="showTab('teachers')"><i class="fas fa-chalkboard-teacher"></i> Teachers</div>
    <div class="nav-link" onclick="showTab('courses')"><i class="fas fa-book"></i> Manage Courses</div>
    <div class="nav-link" onclick="showTab('classes')"><i class="fas fa-layer-group"></i> Manage Classes</div>
    <div class="nav-link" onclick="showTab('exams')"><i class="fas fa-file-signature"></i> Manage Exams</div>
    <div class="nav-link" onclick="showTab('grades')"><i class="fas fa-graduation-cap"></i> Student Grades</div>
    <div class="nav-link" onclick="showTab('attendance')"><i class="fas fa-calendar-check"></i> Attendance</div>
    
    <div class="nav-link logout-link" onclick="logoutAdmin()" style="margin-top:auto;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </div>
</div>

<div class="main-content">

    <div id="newRequests" class="tab-content active">
        <div class="form-card">
            <h3>Pending Admission Requests</h3>
            <table>
                <thead>
                    <tr><th>Full Name</th><th>ID/User</th><th>Faculty</th><th>Action</th></tr>
                </thead>
                <tbody id="requestTable"></tbody>
            </table>
        </div>
    </div>

    <div id="register" class="tab-content">
        <div class="form-card">
            <h3 id="studentFormTitle">Student Management</h3>
            <input type="hidden" id="editStudentId" value="">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="input-group"><label>Full Name</label><input type="text" id="regName"></div>
                <div class="input-group"><label>Student ID</label><input type="text" id="regID"></div>
                <div class="input-group"><label>Email</label><input type="email" id="regEmail"></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div class="input-group"><label>Parent Name</label><input type="text" id="regParent"></div>
                <div class="input-group"><label>Parent Phone</label><input type="text" id="regPPhone"></div>
                <div class="input-group"><label>Faculty</label>
                    <select id="regFaculty">
                        <option>IT & Computer Science</option>
                        <option>Business Administration</option>
                        <option>Engineering</option>
                        <option>Medicine</option>
                    </select>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr; margin-top: 15px;">
                <div class="input-group"><label>Set Login Password</label><input type="password" id="regPassword" placeholder="Enter student password"></div>
            </div>
            <button id="studentSaveBtn" class="btn-submit" style="background:#0a2540; margin-top:15px;" onclick="saveStudent()">Save Student</button>
            <hr>
            
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="studentSearch" placeholder="Search by Name or ID..." onkeyup="searchStudents()">
            </div>
            
            <table>
                <thead><tr><th>Name</th><th>ID</th><th>Faculty</th><th>Action</th></tr></thead>
                <tbody id="studentTable"></tbody>
            </table>
        </div>
    </div>

    <div id="teachers" class="tab-content">
        <div class="form-card">
            <h3>Teacher Management</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div class="input-group"><label>Teacher Name</label><input type="text" id="tName"></div>
                <div class="input-group"><label>Username</label><input type="text" id="tUser"></div>
                <div class="input-group"><label>Department</label><input type="text" id="tDept"></div>
            </div>
            <div class="input-group"><label>Password</label><input type="password" id="tPass"></div>
            <button class="btn-submit" style="background:#0a2540; margin-top:15px;" onclick="saveTeacher()">Save Teacher</button>
            <hr>
            <table><thead><tr><th>Name</th><th>Username</th><th>Dept</th><th>Action</th></tr></thead><tbody id="teacherTableBody"></tbody></table>
        </div>
    </div>

    <div id="courses" class="tab-content">
        <div class="form-card">
            <h3>Course Management</h3>
            <div style="display: flex; gap: 15px;">
                <div class="input-group" style="flex: 2;"><label>Course Name</label><input type="text" id="courseName"></div>
                <div class="input-group" style="flex: 1;"><label>Cr. Hours</label><input type="number" id="courseCrh" value="3"></div>
                <button class="btn-submit" style="background:#0a2540; margin-top:25px; width: 150px;" onclick="saveCourse()">Add Course</button>
            </div>
            <table><thead><tr><th>Course Name</th><th>Credits</th><th>Action</th></tr></thead><tbody id="courseTableBody"></tbody></table>
        </div>
    </div>

    <div id="classes" class="tab-content">
        <div class="form-card">
            <h3>Assign Teacher to Course</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="input-group"><label>Teacher</label><select id="classTeacher"></select></div>
                <div class="input-group"><label>Course</label><select id="classCourse"></select></div>
            </div>
            <button class="btn-submit" style="background:#0a2540; margin-top:15px;" onclick="saveClass()">Create Class Relation</button>
            <table><thead><tr><th>Teacher</th><th>Course</th><th>Action</th></tr></thead><tbody id="classTableBody"></tbody></table>
        </div>
    </div>

    <div id="exams" class="tab-content">
        <div class="form-card">
            <h3>Exam Management</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                <div class="input-group"><label>Course</label><select id="examCourse"></select></div>
                <div class="input-group"><label>Type</label><select id="examType"><option>Mid-Term</option><option>Final</option></select></div>
                <div class="input-group"><label>Date</label><input type="date" id="examDate"></div>
                <div class="input-group"><label>Time</label><input type="time" id="examTime"></div>
            </div>
            <button class="btn-submit" style="background:#0a2540; margin-top:15px;" onclick="saveExam()">Schedule Exam</button>
            <table><thead><tr><th>Course</th><th>Type</th><th>Date & Time</th><th>Action</th></tr></thead><tbody id="examTableBody"></tbody></table>
        </div>
    </div>

    <div id="grades" class="tab-content">
        <div class="form-card">
            <h3>Record Student Grades</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                <div class="input-group"><label>Student</label><select id="gradeStudent"></select></div>
                <div class="input-group"><label>Course</label><select id="gradeCourse"></select></div>
                <div class="input-group"><label>Type</label><select id="gradeType"><option>Mid</option><option>Final</option></select></div>
                <div class="input-group"><label>Score</label><input type="number" id="gradeScore"></div>
            </div>
            <button class="btn-submit" style="background:#0a2540; margin-top:15px;" onclick="saveGrade()">Save Grade</button>
            <table><thead><tr><th>Student</th><th>Course</th><th>Type</th><th>Score</th><th>Action</th></tr></thead><tbody id="gradeTableBody"></tbody></table>
        </div>
    </div>

    <div id="attendance" class="tab-content">
        <div class="form-card">
            <h3>Daily Attendance</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                <div class="input-group"><label>Date</label><input type="date" id="attDate"></div>
                <div class="input-group"><label>Student</label><select id="attStudent"></select></div>
                <div class="input-group"><label>Course</label><select id="attCourse"></select></div>
                <div class="input-group"><label>Status</label><select id="attStatus"><option>Present</option><option>Absent</option></select></div>
            </div>
            <button class="btn-submit" style="background:#0a2540; margin-top:15px;" onclick="saveAttendance()">Mark Attendance</button>
            <table><thead><tr><th>Date</th><th>Student</th><th>Course</th><th>Status</th><th>Action</th></tr></thead><tbody id="attTableBody"></tbody></table>
        </div>
    </div>

</div>

<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="review-header">
            <h3><i class="fas fa-file-invoice"></i> Online Admission Review</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="review-body">
            <div class="form-section-title">1. Student Details</div>
            <div class="form-look-grid">
                <div class="view-group"><label>Full Name</label><span id="viewName"></span></div>
                <div class="view-group"><label>Desired ID</label><span id="viewID"></span></div>
                <div class="view-group"><label>Login Password</label><span id="viewPassword" style="color:blue; font-weight:bold;"></span></div>
            </div>

            <div class="form-section-title">2. Parent Information</div>
            <div class="form-look-grid">
                <div class="view-group"><label>Parent Name</label><span id="viewParent"></span></div>
                <div class="view-group"><label>Parent Phone</label><span id="viewPPhone"></span></div>
            </div>

            <div class="form-section-title">3. Uploaded Documents</div>
            <div class="doc-preview-grid">
                <div class="doc-box"><label>Student Photo</label><img id="viewPhoto" src=""></div>
                <div class="doc-box"><label>Certificate</label><img id="viewCert" src=""></div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="btn-submit" style="background:#28a745; flex:1;" id="approveBtn">Approve Application</button>
                <button class="btn-submit" style="background:#dc3545; flex:1;" id="rejectBtn">Reject Application</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- AUTH & LOGOUT ---
    function logoutAdmin() {
        localStorage.removeItem("currentUser");
        window.location.href = "../login/index.html";
    }

    // --- NAVIGATION & RENDER ---
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            if(link.getAttribute('onclick') && link.getAttribute('onclick').includes(tabId)) {
                link.classList.add('active');
            }
        });

        document.getElementById(tabId).classList.add('active');
        renderAll();
    }

    function renderAll() {
        renderRequests();
        renderStudents();
        renderTeachers();
        renderCourses();
        renderClasses();
        renderExams();
        renderGrades();
        renderAttendance();
        updateDropdowns();
    }

    // --- STUDENT MANAGEMENT ---
    function renderStudents() {
        // Halkan waxaan ka soo akhrineynaa xogta hadda jirta
        const s = JSON.parse(localStorage.getItem("students")) || [];
        displayStudentList(s);
    }

    function displayStudentList(list) {
        const table = document.getElementById('studentTable');
        table.innerHTML = ""; // Nadiifi table-ka horta

        list.forEach(x => {
            const row = `
                <tr>
                    <td>${x.name}</td>
                    <td>${x.id}</td>
                    <td>${x.faculty}</td>
                    <td>
                        <button class="btn-edit" onclick="editStudent('${x.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteItem('students','id','${x.id}')">X</button>
                    </td>
                </tr>`;
            table.innerHTML += row;
        });
    }

    // --- SEARCH FUNCTION (Halkan ayaa la saxay) ---
    function searchStudents() {
        const query = document.getElementById('studentSearch').value.toLowerCase();
        const allStudents = JSON.parse(localStorage.getItem("students")) || [];
        
        // Shaandhee liiska iyadoo la eegayo magaca ama ID-ga
        const filtered = allStudents.filter(s => {
            return s.name.toLowerCase().includes(query) || 
                   s.id.toString().toLowerCase().includes(query);
        });

        // Dib u tusi liiska la shaandheeyay
        displayStudentList(filtered);
    }

    function saveStudent() {
        const id = document.getElementById('regID').value;
        const eid = document.getElementById('editStudentId').value;
        let s = JSON.parse(localStorage.getItem("students")) || [];
        
        const data = { 
            id, 
            name: document.getElementById('regName').value, 
            email: document.getElementById('regEmail').value, 
            faculty: document.getElementById('regFaculty').value 
        };

        if(!data.name || !data.id) return alert("Please fill Name and ID");
        
        if(eid) { 
            const idx = s.findIndex(x => x.id == eid);
            if(idx !== -1) s[idx] = data; 
        } else { 
            s.push(data); 
        }
        
        localStorage.setItem("students", JSON.stringify(s));
        resetForms(); 
        renderStudents();
    }

    function editStudent(id) {
        const s = JSON.parse(localStorage.getItem("students")) || [];
        const student = s.find(x => x.id == id);
        if(student) {
            document.getElementById('regName').value = student.name;
            document.getElementById('regID').value = student.id;
            document.getElementById('regEmail').value = student.email || "";
            document.getElementById('regFaculty').value = student.faculty;
            document.getElementById('editStudentId').value = student.id;
            document.getElementById('studentSaveBtn').innerText = "Update Student";
            window.scrollTo(0,0);
        }
    }

    // --- GRADES ---
    function renderGrades() {
        const g = JSON.parse(localStorage.getItem("student_grades")) || [];
        document.getElementById('gradeTableBody').innerHTML = g.map((x, i) => `
            <tr>
                <td>${x.student}</td>
                <td>${x.course}</td>
                <td>${x.type}</td>
                <td><b>${x.score}</b></td>
                <td><button class="btn-delete" onclick="deleteIndex('student_grades', ${i})">X</button></td>
            </tr>`).join('');
    }

    function saveGrade() {
        const data = {
            student: document.getElementById('gradeStudent').value,
            course: document.getElementById('gradeCourse').value,
            type: document.getElementById('gradeType').value,
            score: document.getElementById('gradeScore').value
        };
        if(!data.score) return alert("Enter score");
        let g = JSON.parse(localStorage.getItem("student_grades")) || [];
        g.push(data);
        localStorage.setItem("student_grades", JSON.stringify(g));
        renderGrades();
    }

    // --- ATTENDANCE ---
    function renderAttendance() {
        const a = JSON.parse(localStorage.getItem("attendance_records")) || [];
        document.getElementById('attTableBody').innerHTML = a.map((x, i) => `
            <tr>
                <td>${x.date}</td>
                <td>${x.student}</td>
                <td>${x.course}</td>
                <td>${x.status}</td>
                <td><button class="btn-delete" onclick="deleteIndex('attendance_records', ${i})">X</button></td>
            </tr>`).join('');
    }

    function saveAttendance() {
        const data = {
            date: document.getElementById('attDate').value,
            student: document.getElementById('attStudent').value,
            course: document.getElementById('attCourse').value,
            status: document.getElementById('attStatus').value
        };
        if(!data.date) return alert("Select Date");
        let a = JSON.parse(localStorage.getItem("attendance_records")) || [];
        a.push(data);
        localStorage.setItem("attendance_records", JSON.stringify(a));
        renderAttendance();
    }

    // --- UI HELPERS ---
    function updateDropdowns() {
        const s = JSON.parse(localStorage.getItem("students")) || [];
        const c = JSON.parse(localStorage.getItem("globalCourses")) || [];
        const t = JSON.parse(localStorage.getItem("teachers")) || [];
        
        const sOpts = s.length ? s.map(x => `<option value="${x.name} (${x.id})">${x.name} (${x.id})</option>`).join('') : "<option>No Students</option>";
        const cOpts = c.length ? c.map(x => `<option value="${x.name}">${x.name}</option>`).join('') : "<option>No Courses</option>";
        const tOpts = t.length ? t.map(x => `<option value="${x.name}">${x.name}</option>`).join('') : "<option>No Teachers</option>";

        document.getElementById('gradeStudent').innerHTML = sOpts;
        document.getElementById('attStudent').innerHTML = sOpts;
        document.getElementById('gradeCourse').innerHTML = cOpts;
        document.getElementById('attCourse').innerHTML = cOpts;
        document.getElementById('classTeacher').innerHTML = tOpts;
        document.getElementById('classCourse').innerHTML = cOpts;
        document.getElementById('examCourse').innerHTML = cOpts;
    }

    // --- ADMISSION REQUESTS ---
    function renderRequests() {
        const r = JSON.parse(localStorage.getItem("admas_registrations")) || [];
        document.getElementById('reqBadge').innerText = r.length;
        document.getElementById('requestTable').innerHTML = r.map((x, i) => `
            <tr>
                <td>${x.name}</td>
                <td>${x.user||'N/A'}</td>
                <td>${x.faculty}</td>
                <td><button class="btn-view" onclick="reviewRequest(${i})">Review</button></td>
            </tr>`).join('');
    }

    function reviewRequest(index) {
        const r = JSON.parse(localStorage.getItem("admas_registrations")) || [];
        const data = r[index];
        if(!data) return;

        document.getElementById('viewName').innerText = data.name;
        document.getElementById('viewID').innerText = data.user || 'N/A';
        document.getElementById('viewParent').innerText = data.parentName || 'N/A';
        document.getElementById('viewPPhone').innerText = data.parentPhone || 'N/A';
        document.getElementById('viewPhoto').src = data.photo || '';
        document.getElementById('viewCert').src = data.certificate || '';

        document.getElementById('approveBtn').onclick = () => {
            let s = JSON.parse(localStorage.getItem("students")) || [];
            s.push({id: data.user || Date.now(), name: data.name, faculty: data.faculty});
            localStorage.setItem("students", JSON.stringify(s));
            r.splice(index, 1);
            localStorage.setItem("admas_registrations", JSON.stringify(r));
            closeModal(); renderAll(); alert("Student Approved!");
        };
        document.getElementById('rejectBtn').onclick = () => {
            if(confirm("Reject this?")) { 
                r.splice(index, 1); 
                localStorage.setItem("admas_registrations", JSON.stringify(r)); 
                closeModal(); 
                renderAll(); 
            }
        };

        document.getElementById('detailsModal').style.display = "block";
    }

    // --- GENERAL DELETE & FORM RESET ---
    function deleteItem(k, p, v) { 
        if(confirm("Delete?")) { 
            let list = JSON.parse(localStorage.getItem(k)) || [];
            list = list.filter(x => x[p] != v); 
            localStorage.setItem(k, JSON.stringify(list)); 
            renderAll(); 
        } 
    }
    
    function deleteIndex(k, i) { 
        if(confirm("Delete this record?")) { 
            let d = JSON.parse(localStorage.getItem(k)) || [];
            d.splice(i, 1); 
            localStorage.setItem(k, JSON.stringify(d)); 
            renderAll(); 
        } 
    }
    
    function resetForms() { 
        document.querySelectorAll('input').forEach(i => i.value = ""); 
        if(document.getElementById('studentSaveBtn')) document.getElementById('studentSaveBtn').innerText = "Save Student"; 
        document.getElementById('editStudentId').value = "";
    }
    
    function closeModal() { 
        document.getElementById('detailsModal').style.display = "none"; 
    }

    // --- TEACHERS, COURSES, CLASSES & EXAMS ---
    function saveTeacher() {
        let t = JSON.parse(localStorage.getItem("teachers")) || [];
        t.push({name:document.getElementById('tName').value, user:document.getElementById('tUser').value, dept:document.getElementById('tDept').value});
        localStorage.setItem("teachers", JSON.stringify(t)); 
        renderTeachers();
        resetForms();
    }
    
    function renderTeachers() {
        const t = JSON.parse(localStorage.getItem("teachers")) || [];
        document.getElementById('teacherTableBody').innerHTML = t.map(x => `<tr><td>${x.name}</td><td>${x.user}</td><td>${x.dept}</td><td><button class="btn-delete" onclick="deleteItem('teachers','user','${x.user}')">X</button></td></tr>`).join('');
    }
    
    function saveCourse() {
        let c = JSON.parse(localStorage.getItem("globalCourses")) || [];
        c.push({id:Date.now(), name:document.getElementById('courseName').value, crh:document.getElementById('courseCrh').value});
        localStorage.setItem("globalCourses", JSON.stringify(c)); 
        renderCourses();
        resetForms();
    }
    
    function renderCourses() {
        const c = JSON.parse(localStorage.getItem("globalCourses")) || [];
        document.getElementById('courseTableBody').innerHTML = c.map(x => `<tr><td>${x.name}</td><td>${x.crh}</td><td><button class="btn-delete" onclick="deleteItem('globalCourses','id','${x.id}')">X</button></td></tr>`).join('');
    }
    
    function saveClass() {
        let cl = JSON.parse(localStorage.getItem("assignedClasses")) || [];
        cl.push({id:Date.now(), teacher:document.getElementById('classTeacher').value, course:document.getElementById('classCourse').value});
        localStorage.setItem("assignedClasses", JSON.stringify(cl)); 
        renderClasses();
    }
    
    function renderClasses() {
        const cl = JSON.parse(localStorage.getItem("assignedClasses")) || [];
        document.getElementById('classTableBody').innerHTML = cl.map(x => `<tr><td>${x.teacher}</td><td>${x.course}</td><td><button class="btn-delete" onclick="deleteItem('assignedClasses','id','${x.id}')">X</button></td></tr>`).join('');
    }
    
    function saveExam() {
        let e = JSON.parse(localStorage.getItem("exams")) || [];
        e.push({id:Date.now(), course:document.getElementById('examCourse').value, type:document.getElementById('examType').value, date:document.getElementById('examDate').value});
        localStorage.setItem("exams", JSON.stringify(e)); 
        renderExams();
        resetForms();
    }
    
    function renderExams() {
        const e = JSON.parse(localStorage.getItem("exams")) || [];
        document.getElementById('examTableBody').innerHTML = e.map(x => `<tr><td>${x.course}</td><td>${x.type}</td><td>${x.date}</td><td><button class="btn-delete" onclick="deleteItem('exams','id','${x.id}')">X</button></td></tr>`).join('');
    }

    window.onload = renderAll;
</script>
</body>
</html>